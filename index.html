<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect Revenue Scanner</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background-color: #f0f2f5; margin: 0; }
        .container { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.12); text-align: center; max-width: 400px; width: 90%; }
        h1 { color: #1c1e21; margin-bottom: 10px; font-size: 24px; }
        p { color: #606770; margin-bottom: 30px; line-height: 1.5; }
        .fb-btn { background-color: #1877f2; color: white; border: none; padding: 14px 24px; font-size: 16px; font-weight: bold; border-radius: 6px; cursor: pointer; transition: background 0.2s; width: 100%; }
        .fb-btn:hover { background-color: #166fe5; }
        #status { margin-top: 20px; font-size: 14px; font-weight: 600; }
        .success { color: #00a400; }
        .error { color: #fa383e; }
    </style>
</head>
<body>

<div class="container">
    <h1>Revenue Scanner</h1>
    <p>Connect your Facebook Page to enable AI Analysis. We only read messages to track sales performance.</p>
    
    <button class="fb-btn" onclick="loginWithFacebook()">
        Connect with Facebook
    </button>
    
    <div id="status"></div>
</div>

<script>
  // ================= CONFIGURATION =================
  const APP_ID = '1283451296932731'; 
  const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzYOcc-7WRJ2YMRI1CodT_njMR8Kjyzjfx1rhFaKxkK9Zxk4TvAsh6w86deg3NYDYlWwg/exec'; 
  // =================================================

  // 1. Initialize Facebook SDK
  window.fbAsyncInit = function() {
    FB.init({
      appId      : APP_ID,
      cookie     : true,
      xfbml      : true,
      version    : 'v19.0'
    });
  };

  // Load SDK asynchronously
  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "https://connect.facebook.net/en_US/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));

  // 2. Login Function
  function loginWithFacebook() {
    document.getElementById('status').className = '';
    document.getElementById('status').innerText = 'Opening Facebook...';

    FB.login(function(response) {
      if (response.authResponse) {
        const userToken = response.authResponse.accessToken;
        document.getElementById('status').innerText = 'Logged in. Fetching Pages...';
        
        // Get User Name
        FB.api('/me', function(user) {
            fetchPages(userToken, user.name);
        });

      } else {
        document.getElementById('status').innerText = 'Login cancelled.';
        document.getElementById('status').className = 'error';
      }
    }, {
      // Permissions required to read messages
      scope: 'pages_show_list,pages_read_engagement,pages_messaging,pages_manage_posts'
    });
  }

  // 3. Get Page Token
  function fetchPages(userToken, userName) {
    FB.api('/me/accounts', function(response) {
      if (response.data && response.data.length > 0) {
        // We grab the FIRST page found for this MVP
        // In the future, you can make a dropdown list if they have multiple pages
        const page = response.data[0];
        sendToGoogle(userName, page.name, page.id, page.access_token);
      } else {
        document.getElementById('status').innerText = 'No Business Pages found on this account.';
        document.getElementById('status').className = 'error';
      }
    });
  }

  // 4. Send to Google Sheet
  function sendToGoogle(user, page, id, token) {
    document.getElementById('status').innerText = 'Connecting to Scanner Database...';
    
    const payload = {
        type: "NEW_CLIENT",
        userName: user,
        pageName: page,
        pageId: id,
        token: token
    };

       fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors', // standard for GAS webhooks
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    }).then(() => {
        // === UPDATE STARTS HERE ===
        document.getElementById('status').innerText = 'âœ… Success! Redirecting to Dashboard...';
        document.getElementById('status').className = 'success';
        document.querySelector('.fb-btn').style.display = 'none'; // Hide button

        // Redirect to dashboard.html with the client name parameter
        setTimeout(() => {
            window.location.href = `dashboard.html?client=${encodeURIComponent(page)}`;
        }, 1500); 
        // === UPDATE ENDS HERE ===

    }).catch(err => {
        console.error(err);
        document.getElementById('status').innerText = 'Error connecting to database.';
        document.getElementById('status').className = 'error';
    });
  }
</script>

</body>
</html>

